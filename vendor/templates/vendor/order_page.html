{% extends 'vendor_base.html' %}
{% load static %}

{% block vendor_content %}
<div class="mb-8">
    <h1 class="text-3xl font-heading font-black uppercase italic tracking-tighter">
        Active <span class="text-primary">Orders</span>
    </h1>

    <p class="text-xs text-base-content/60 uppercase tracking-widest font-bold">
      Live kitchen queue
    </p>

  <span class="badge badge-outline badge-primary font-black text-xs">
    {{ active_orders|length }} Orders
  </span>
</div>

<div class="flex flex-col md:flex-row gap-4 mb-6 items-center justify-between bg-white p-4 rounded-3xl border border-cream shadow-soft">
    <div class="relative w-full md:w-96">
        <span class="absolute inset-y-0 left-4 flex items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </span>
        <input type="text" id="orderSearch" onkeyup="filterOrders()" 
               placeholder="Search Order ID or Name..." 
               class="input input-ghost w-full pl-12 bg-base-200 rounded-2xl font-bold text-charcoal focus:bg-white focus:border-primary transition-all uppercase text-xs tracking-widest">
    </div>

    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
        <span class="text-[10px] font-black uppercase text-gray-400 self-center mr-2 hidden lg:block">Quick Filter:</span>
        <button onclick="quickFilter('all')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-primary hover:text-white">All</button>
        <button onclick="quickFilter('COD')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-error hover:text-white text-error">COD</button>
        <button onclick="quickFilter('Paid')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-success hover:text-white text-success">Paid</button>
    </div>
</div>

<div class="overflow-x-auto bg-white rounded-4xl shadow-heavy border border-cream">
    <table class="table table-zebra w-full border-separate border-spacing-y-2 px-4">
        <thead>
            <tr class="text-charcoal uppercase text-[11px] font-black tracking-widest border-none">
                <th class="bg-transparent">Order Info</th>
                <th class="hidden md:table-cell bg-transparent">Zone</th>
                <th class="hidden sm:table-cell bg-transparent">Payment</th>
                <th class="bg-transparent">Status</th>
                <th class="text-right bg-transparent">Actions</th>
            </tr>
        </thead>
        
        <tbody>
            {% for order in active_orders %}
            <tr class="group border-none shadow-sm hover:shadow-md transition-all" id="order-row-{{ order.id }}">
                <td class="rounded-l-2xl border-none">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleDetails('{{ order.id }}')" class="btn btn-circle btn-xs btn-ghost text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-300" id="icon-{{ order.id }}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div>
                            <span class="font-black text-charcoal text-base">#{{ order.id }}</span>
                            <p class="text-[10px] font-bold text-gray-500 uppercase">{{ order.name }} â€¢ {{ order.created_at|timesince }} ago</p>
                        </div>
                    </div>
                </td>
                
                <td class="hidden md:table-cell border-none">
                    <span class="text-[10px] font-black uppercase text-charcoal tracking-tighter italic">
                        {{ order.delivery_zone.name|default:"Pickup" }}
                    </span>
                </td>

                <td class="hidden sm:table-cell border-none">
                    {% if order.payment_ref == "Pay on Delivery" %}
                        <span class="badge badge-error badge-outline font-black text-[9px] uppercase tracking-tighter">COD</span>
                    {% else %}
                        <span class="badge badge-success font-black text-[9px] uppercase tracking-tighter text-white">Paid</span>
                    {% endif %}
                </td>

                <td class="border-none">
                    <span class="badge badge-ghost font-black text-[10px] uppercase italic text-gray-500">
                        {{ order.get_status_display }}
                    </span>
                </td>

                <td class="text-right rounded-r-2xl border-none">
                    <div class="flex justify-end gap-2">
                        <a href="{% url 'order_receipt' order.id %}" target="_blank" class="btn btn-square btn-sm bg-white border-cream hover:bg-primary group/btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover/btn:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                        </a>
                        
                        {% if order.status == 'pending' %}
                            <button onclick="updateOrderStatus('{{ order.id }}', 'preparing')" class="btn btn-sm btn-success text-white font-black uppercase text-[10px] italic">Start Prep</button>
                        {% elif order.status == 'preparing' %}
                            <button onclick="updateOrderStatus('{{ order.id }}', 'ready')" class="btn btn-sm btn-info text-white font-black uppercase text-[10px] italic">Ready</button>
                        {% elif order.status == 'ready' %}
                            <button onclick="updateOrderStatus('{{ order.id }}', 'shipped')" class="btn btn-sm btn-primary text-soft-black font-black uppercase text-[10px] italic">Dispatch</button>
                        {% endif %}
                    </div>
                </td>
            </tr>

            <tr id="details-{{ order.id }}" class="hidden">
                <td colspan="5" class="bg-base-100 rounded-2xl border-2 border-dashed border-cream/50 p-0 overflow-hidden">
                    <div class="p-6 flex flex-col md:flex-row gap-8">
                        <div class="grow space-y-4">
                            {% for pack in order.packs.all %}
                            <div class="pack-container">
                                <h4 class="text-[11px] font-black uppercase text-primary border-b border-cream pb-1 mb-3">{{ pack.name }}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {% for item in pack.items.all %}
                                    <div class="flex items-center gap-3">
                                        <span class="w-6 h-6 flex-none rounded bg-charcoal text-primary text-[10px] font-black flex items-center justify-center">{{ item.quantity }}</span>
                                        <span class="text-xs font-bold text-charcoal uppercase leading-tight">{{ item.product.name }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="w-full md:w-64 flex-none space-y-4">
                            {% if order.delivery_note %}
                            <div class="bg-error/5 p-4 rounded-2xl border border-error/20">
                                <p class="text-[9px] font-black text-error uppercase mb-1">Kitchen Note</p>
                                <p class="text-[11px] italic font-medium text-charcoal leading-relaxed">{{ order.delivery_note }}</p>
                            </div>
                            {% endif %}
                            <div class="bg-cream/30 p-4 rounded-2xl border border-cream text-[11px]">
                                <p class="font-bold text-charcoal mb-1 uppercase tracking-tighter">Contact: {{ order.phone }}</p>
                                <p class="text-gray-500 leading-tight uppercase">{{ order.address }}</p>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center py-20">
                    <p class="font-heading font-black text-gray-300 uppercase italic text-4xl">No Active Orders</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle the dropdown toggle
    function toggleDetails(orderId) {
        const detailsRow = document.getElementById(`details-${orderId}`);
        const icon = document.getElementById(`icon-${orderId}`);
        
        const isHidden = detailsRow.classList.contains('hidden');
        
        if (isHidden) {
            detailsRow.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
        } else {
            detailsRow.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function updateOrderStatus(orderId, status) {
        const row = document.getElementById(`order-row-${orderId}`);
        const details = document.getElementById(`details-${orderId}`);
        
        row.style.opacity = '0.5';
        if (details) details.style.opacity = '0.5';

        fetch(`/vendor/order/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // If it was dispatched or finished, remove it. 
                // Otherwise, reload to update the action button state
                location.reload(); 
            }
        });
    }

    function filterOrders() {
        const input = document.getElementById("orderSearch");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("ordersTable");
        const rows = table.getElementsByClassName("group"); // Selecting main rows only
        let foundCount = 0;

        for (let i = 0; i < rows.length; i++) {
            // We check the ID span and the Name paragraph inside the first <td>
            const textContent = rows[i].getElementsByTagName("td")[0].textContent.toUpperCase();
            const detailsRow = document.getElementById(`details-${rows[i].id.split('-').pop()}`);

            if (textContent.indexOf(filter) > -1) {
                rows[i].style.display = "";
                foundCount++;
            } else {
                rows[i].style.display = "none";
                // Also hide the expanded details if the main row is hidden
                if (detailsRow) detailsRow.classList.add('hidden');
            }
        }

        // Toggle "No Results" message
        document.getElementById("noResults").classList.toggle('hidden', foundCount > 0);
    }

    function quickFilter(type) {
        const rows = document.getElementById("ordersTable").getElementsByClassName("group");
        const searchInput = document.getElementById("orderSearch");
        
        // Clear search bar when using quick filters
        searchInput.value = ""; 

        for (let i = 0; i < rows.length; i++) {
            const paymentBadge = rows[i].querySelector('.badge').textContent.toUpperCase();
            const detailsRow = document.getElementById(`details-${rows[i].id.split('-').pop()}`);

            if (type === 'all' || paymentBadge.includes(type.toUpperCase())) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
                if (detailsRow) detailsRow.classList.add('hidden');
            }
        }
    }
</script>
{% endblock %}