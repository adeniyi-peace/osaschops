{% extends 'vendor_base.html' %}
{% load static %}

{% block vendor_content %}
<div class="mb-8">
    <h1 class="text-3xl font-heading font-black uppercase italic tracking-tighter">
        Active <span class="text-primary">Orders</span>
    </h1>

    <p class="text-xs text-base-content/60 uppercase tracking-widest font-bold">
      Live kitchen queue
    </p>

  <span id="number-of-active-order" class="badge badge-outline badge-primary font-black text-xs">
    {{ active_orders|length }} Orders
  </span>
</div>

<div class="flex flex-col md:flex-row gap-4 mb-6 items-center justify-between bg-white p-4 rounded-3xl border border-cream shadow-soft">
    <div class="relative w-full md:w-96">
        <span class="absolute inset-y-0 left-4 flex items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </span>
        <input type="text" id="orderSearch" onkeyup="filterOrders()" 
               placeholder="Search Order ID or Name..." 
               class="input input-ghost w-full pl-12 bg-base-200 rounded-2xl font-bold text-charcoal focus:bg-white focus:border-primary transition-all uppercase text-xs tracking-widest">
    </div>

    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
        <span class="text-[10px] font-black uppercase text-gray-400 self-center mr-2 hidden lg:block">Quick Filter:</span>
        <button onclick="quickFilter('all')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-primary hover:text-white">All</button>
        <button onclick="quickFilter('COD')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-error hover:text-white text-error">COD</button>
        <button onclick="quickFilter('Paid')" class="btn btn-xs rounded-xl font-black uppercase px-4 border-cream hover:bg-success hover:text-white text-success">Paid</button>
    </div>
</div>

<div class="overflow-x-auto bg-white rounded-4xl shadow-heavy border border-cream">
    <table class="table table-zebra w-full border-separate border-spacing-y-2 px-4">
        <thead>
            <tr class="text-charcoal uppercase text-[11px] font-black tracking-widest border-none">
                <th class="bg-transparent">Order Info</th>
                <th class="hidden md:table-cell bg-transparent">Zone</th>
                <th class="hidden sm:table-cell bg-transparent">Payment</th>
                <th class="bg-transparent">Status</th>
                <th class="text-right bg-transparent">Actions</th>
            </tr>
        </thead>
        
        <tbody>
            {% for order in active_orders %}
            {% include "vendor/includes/order_card.html" %}
            {% empty %}
            <tr>
                <td colspan="5" class="text-center py-20">
                    <p class="font-heading font-black text-gray-300 uppercase italic text-4xl">No Active Orders</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle the dropdown toggle
    function toggleDetails(orderId) {
        const detailsRow = document.getElementById(`details-${orderId}`);
        const icon = document.getElementById(`icon-${orderId}`);
        
        const isHidden = detailsRow.classList.contains('hidden');
        
        if (isHidden) {
            detailsRow.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
        } else {
            detailsRow.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function updateOrderStatus(orderId, status) {
        const row = document.getElementById(`order-row-${orderId}`);
        const details = document.getElementById(`details-${orderId}`);
        const csrftoken = getCSRFCookie()
        
        row.style.opacity = '0.5';
        if (details) details.style.opacity = '0.5';

        fetch(`/vendor/orders/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // If it was dispatched or finished, remove it. 
                // Otherwise, reload to update the action button state
                location.reload(); 
            }
        });
    }

    function filterOrders() {
        const input = document.getElementById("orderSearch");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("ordersTable");
        const rows = table.getElementsByClassName("group"); // Selecting main rows only
        let foundCount = 0;

        for (let i = 0; i < rows.length; i++) {
            // We check the ID span and the Name paragraph inside the first <td>
            const textContent = rows[i].getElementsByTagName("td")[0].textContent.toUpperCase();
            const detailsRow = document.getElementById(`details-${rows[i].id.split('-').pop()}`);

            if (textContent.indexOf(filter) > -1) {
                rows[i].style.display = "";
                foundCount++;
            } else {
                rows[i].style.display = "none";
                // Also hide the expanded details if the main row is hidden
                if (detailsRow) detailsRow.classList.add('hidden');
            }
        }

        // Toggle "No Results" message
        document.getElementById("noResults").classList.toggle('hidden', foundCount > 0);
    }

    function quickFilter(type) {
        const rows = document.getElementById("ordersTable").getElementsByClassName("group");
        const searchInput = document.getElementById("orderSearch");
        
        // Clear search bar when using quick filters
        searchInput.value = ""; 

        for (let i = 0; i < rows.length; i++) {
            const paymentBadge = rows[i].querySelector('.badge').textContent.toUpperCase();
            const detailsRow = document.getElementById(`details-${rows[i].id.split('-').pop()}`);

            if (type === 'all' || paymentBadge.includes(type.toUpperCase())) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
                if (detailsRow) detailsRow.classList.add('hidden');
            }
        }
    }

    // This function matches the check in the global script above
    function refreshOrderTable(order) {
        const tableBody = document.querySelector("tbody");
        
        // Clear "No Active Orders" if it exists
        if(tableBody.innerText.includes("No Active Orders")) tableBody.innerHTML = "";
        

        // 2. Insert the HTML string as actual DOM elements
        // 'afterbegin' puts it at the very top of the <tbody>
        tableBody.insertAdjacentHTML('afterbegin', order.html);

        // 3. Target the newly injected row
        const newRow = tableBody.firstElementChild;


        const newOrderElement = tableBody.firstElementChild;

        newOrderElement.classList.add("new-order-flash");

        // 6. Update the Order Count badge at the top of the page
        const badge = document.querySelector("#number-of-active-order");
        if (badge) {
            let currentCount = parseInt(badge.innerText) || 0;
            badge.innerText = `${currentCount + 1} Orders`;
        }

        // newOrderElement.classList.add("new-order-flash", "bg-orange-50", "border-primary");
        // // 4. Remove the animation after exactly 5 seconds
        // setTimeout(() => {
        //     newOrderElement.classList.remove("animate-pulse", "bg-orange-50", "border-primary");
            
        //     // Optional: Add a smooth transition class so the color fade is gentle
        //     newOrderElement.classList.add("transition-colors", "duration-1000");
        // }, 5000);
        
    }
</script>
{% endblock %}