{% extends 'vendor_base.html' %}
{% load static %}

{% block vendor_content %}
<div class="max-w-5xl mx-auto space-y-10">
    <div data-aos="fade-down">
        <h1 class="text-3xl font-heading font-black uppercase italic tracking-tighter">
            Store <span class="text-primary">Settings</span>
        </h1>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-1">Configure your logistics & business levels</p>
    </div>

    {% if store_form.errors or business_formset.errors or delivery_formset.errors %}
    <div class="alert alert-error rounded-3xl mb-8 shadow-lg border-2 border-white animate-bounce">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span class="font-black uppercase italic text-xs tracking-widest">Update failed! Please check the red highlights below.</span>
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data" class="space-y-8">
        {% csrf_token %}

        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden" data-aos="fade-up">
            <div class="p-8 border-b border-cream bg-base-200/30">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter">Weekly <span class="text-primary">Schedule</span></h3>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Set your active frying hours for each day</p>
            </div>
            
            <div class="p-8 space-y-4">
                {{ business_formset.management_form }}
                <div class="hidden md:grid grid-cols-12 gap-4 px-4 pb-2 text-[10px] font-black uppercase tracking-widest text-gray-400">
                    <div class="col-span-3">Day</div>
                    <div class="col-span-3">Status</div>
                    <div class="col-span-3">Open Time</div>
                    <div class="col-span-3">Close Time</div>
                </div>

                {% if business_formset.non_form_errors %}
                    <div class="p-4 mb-4 bg-error/10 border border-error/20 rounded-2xl text-error font-bold uppercase text-[10px]">
                        {{ business_formset.non_form_errors }}
                    </div>
                {% endif %}
                
                {% for form in business_formset %}
                {{form.errors}}
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-base-200/30 p-4 rounded-2xl border border-transparent hover:border-cream transition-all group">
                    {{ form.id }} 
                    <div class="col-span-3 font-black text-charcoal uppercase text-sm italic">
                        {{ form.day.label }}
                        {{ form.day}}
                        {% if form.day.errors %}<p class="text-[9px] text-error font-black mt-1">{{ form.day.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="col-span-3">
                        <label class="label cursor-pointer justify-start gap-3 p-0">
                            <!-- <input type="checkbox" name="{{ day|lower }}_open" class="toggle toggle-primary toggle-sm day-toggle" checked onchange="toggleTimeInputs(this)"> -->
                             {{ form.is_open }} 
                            <span class="label-text font-bold uppercase text-[10px] status-label">{% if form.instance.is_open %}Open{% else %}Closed{% endif %}</span>
                        </label>
                        {% if form.is_open.errors %}<p class="text-[9px] text-error font-black mt-1">{{ form.is_open.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="col-span-3">
                        {{ form.opening_time }}
                        {% if form.opening_time.errors %}<p class="text-[9px] text-error font-black mt-1">{{ form.opening_time.errors.0 }}</p>{% endif %}
                    </div>
                    <div class="col-span-3">
                        {{ form.closing_time }}
                        {% if form.closing_time.errors %}<p class="text-[9px] text-error font-black mt-1">{{ form.closing_time.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="closed {% if not form.instance.is_open %}hidden{% endif %} col-span-6">
                        <div class="flex gap-2 w-66 bg-gray-200 items-center px-2 py-1 rounded">
                            <svg class="size-6" xmlns="http://www.w3.org/2000/svg" fill="#CC5500" viewBox="0 0 24 24">
                                <path d="M14.5 6A6 6 0 1 0 18 14.5 4.5 4.5 0 0 1 14.5 6Z"/>
                        </svg>
                            <h1 class="font-semibold text-gray-500">Closed</h1>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {{store_form.errors}}
        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden" data-aos="fade-up">
            <div class="p-8 border-b border-cream">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter">Hero <span class="text-primary">Branding</span></h3>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Control the main banner text and imagery</p>
            </div>
            <div class="p-8 space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-black uppercase text-[10px] text-gray-400">Promo Badge</span></label>
                        {{ store_form.hero_badge }}
                        {% if store_form.hero_badge.errors %}
                            <p class="text-[9px] text-error font-black uppercase mt-1 italic">{{ store_form.hero_badge.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-black uppercase text-[10px] text-gray-400">Main Title</span></label>
                        {{ store_form.hero_title}}
                        {% if store_form.hero_title.errors %}
                            <p class="text-[9px] text-error font-black uppercase mt-1 italic">{{ store_form.hero_title.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-black uppercase text-[10px] text-gray-400">Hero Subtitle</span></label>
                    {{ store_form.hero_subtitle }}
                    {% if store_form.hero_subtitle.errors %}
                        <p class="text-[9px] text-error font-black uppercase mt-1 italic">{{ store_form.hero_subtitle.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-black uppercase text-[10px] text-gray-400">Hero Image</span></label>
                    {% if store_settings.hero_image %}
                        <div class="mb-2">
                            <img src="{{ store_settings.hero_image.url }}" class="w-32 h-20 object-cover rounded-lg border border-cream shadow-sm">
                        </div>
                    {% endif %}
                    {{ store_form.hero_image }}
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden">
            <div class="p-8 border-b border-cream">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter">Delivery <span class="text-primary">Zones</span></h3>
            </div>
            {{ delivery_formset.management_form }}
            
            <div class="p-8 space-y-4" id="formset_container">

                <div class="grid grid-cols-12 gap-4 px-4 pb-2 text-[10px] font-black uppercase tracking-widest text-gray-400">
                    <div class="col-span-6">Delivery Area Name</div>
                    <div class="col-span-4">Fee (‚Ç¶)</div>
                    <div class="col-span-2 text-right">Action</div>
                </div>
                
                {% for form in delivery_formset %}
                {{form.errors}}
                <div id="{{ form.prefix }}" class="grid grid-cols-12 gap-4 items-center bg-base-200/50 p-4 rounded-2xl selected-line-item">
                    {{ form.id }}
                    <div class="hidden">{{form.DELETE}}</div>
                    <div class="col-span-6">
                        {{ form.name }}
                        {% if form.name.errors %}
                            <p class="text-[9px] text-error font-black mt-1 uppercase">{{ form.name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="col-span-4">
                        {{ form.fee }}
                        {% if form.fee.errors %}
                            <p class="text-[9px] text-error font-black mt-1 uppercase">{{ form.fee.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="col-span-2 text-right">
                        <button type="button" class="btn btn-ghost btn-circle btn-sm text-error" onclick="deleteLineItem('{{ form.prefix }}')">‚úï</button>
                    </div>
                </div>
                {% endfor %}

                <button type="button" class="btn btn-ghost btn-sm text-primary font-black uppercase text-[10px]" onclick="addLineItem()">+ Add New Zone</button>
            </div>

            <div id="{{ delivery_formset.empty_form.prefix }}" class="empty-form hidden grid-cols-12 gap-4 items-center bg-base-200/50 p-4 rounded-2xl selected-line-item">
                {{ delivery_formset.empty_form.id }}
                <div class="hidden">{{delivery_formset.empty_form.DELETE}}</div>
                <div class="col-span-6 font-bold text-sm uppercase">{{ delivery_formset.empty_form.name }}</div>
                <div class="col-span-4">
                    {{ delivery_formset.empty_form.fee }}
                </div>
                <div class="col-span-2 text-right">
                    <button class="btn btn-ghost btn-circle btn-sm text-error" onclick="deleteLineItem('{{ delivery_formset.empty_form.prefix }}')">‚úï</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden">
            <div class="p-8 border-b border-cream">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter text-charcoal">Integration <span class="text-primary">Hub</span></h3>
            </div>
            <div class="p-8 space-y-6">
                <div class="form-control">
                    <label class="label"><span class="label-text font-black uppercase text-[10px] tracking-widest">Order Notification WhatsApp</span></label>
                    <div class="flex gap-6">
                        <span class="bg-base-200 px-4 flex items-center rounded-xl font-bold text-gray-500">{{store_form.whatsapp_number.0}}</span>
                        {{ store_form.whatsapp_number.1 }}
                    </div>
                    {% if store_form.whatsapp_number.errors %}
                        <p class="text-[9px] text-error font-black mt-2 uppercase">{{ store_form.whatsapp_number.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-black uppercase text-[10px] text-gray-400">Logo</span></label>
                    {% if store_settings.logo %}
                        <div class="mb-2">
                            <img src="{{ store_settings.logo.url }}" class="w-32 h-20 object-contain rounded-lg border border-cream shadow-sm">
                        </div>
                    {% endif %}
                    {{ store_form.logo }}
                    {% if store_form.logo.errors %}
                        <p class="text-[9px] text-error font-black mt-2 uppercase">{{ store_form.logo.errors.0 }}</p>
                    {% endif %}
                </div>
                <!-- <div class="form-control">
                    <label class="label"><span class="label-text font-black uppercase text-[10px] tracking-widest">Automated Customer Message</span></label>
                    <textarea class="textarea textarea-bordered rounded-xl bg-base-200 border-none font-medium h-24">Hi! Your Osaschops levels are being prepped. Order #ID is currently in the fryer! üçó</textarea>
                </div> -->
            </div>
        </div>

        <div class="flex justify-end pt-4 pb-12">
            <button type="submit" class="btn btn-primary px-12 rounded-full font-black uppercase italic shadow-lg shadow-orange-500/20 hover:scale-105 transition-transform">
                Save All Changes
            </button>
        </div>
    </form>
</div>

<script>
function toggleTimeInputs(checkbox) {
    // Find the row container
    const row = checkbox.closest('.grid');
    const timeInputs = row.querySelectorAll('.time-input');
    const statusLabel = row.querySelector('.status-label');
    const closedMessage = row.querySelector('.closed');
    
    if (checkbox.checked) {
        // Enable inputs
        timeInputs.forEach(input => {
            input.closest("div").classList.remove('hidden');
        });
        closedMessage.classList.add("hidden")
        statusLabel.innerText = 'Open';
        statusLabel.classList.add('text-primary');
        statusLabel.classList.remove('text-gray-400');
    } else {
        // Disable inputs
        timeInputs.forEach(input => {
            input.closest("div").classList.add('hidden');
        });
        closedMessage.classList.remove("hidden")
        statusLabel.innerText = 'Closed';
        statusLabel.classList.remove('text-primary');
        statusLabel.classList.add('text-gray-400');
    }

}

const delivery_zone_formset_total_input = document.getElementById("id_delivery_zone-TOTAL_FORMS");
const formset_container = document.getElementById('formset_container');

function addLineItem() {
    const empty_form = document.querySelector(".empty-form").cloneNode(true);
    // Find the current form index
    let currentFormCount = parseInt(delivery_zone_formset_total_input.value);

    // 1. Check for duplicates among forms NOT marked for deletion
    const existingLines = formset_container.querySelectorAll('.selected-line-item');

    // Set the item details and item-specific attributes
    empty_form.id = empty_form.id.replace(/__prefix__/g, `${currentFormCount}`);
    empty_form.innerHTML = empty_form.innerHTML.replace(/__prefix__/g, `${currentFormCount}`)
    empty_form.classList.remove("hidden")
    empty_form.classList.remove("empty-form")
    empty_form.classList.add("grid")
    

    // 3. Append to container and update TOTAL_FORMS
    formset_container.append(empty_form);
    delivery_zone_formset_total_input.value = currentFormCount + 1;

    updateManagementForm();
}

function deleteLineItem(formPrefix) {
    const formElement = document.getElementById(formPrefix);
    if (!formElement) return;

    // Check if the form has an ID field (meaning it's an existing saved line)
    const idInput = formElement.querySelector('input[id$="-id"]');
    
    if (idInput && idInput.value) {
        // Existing item: Mark for deletion by checking the DELETE checkbox and hiding the element
        const deleteCheckbox = formElement.querySelector('input[id$="-DELETE"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            formElement.style.display = 'none';
        }
    } else {
        // New item (no ID): Simply remove from the DOM
        formElement.remove();
    }

    updateManagementForm();
}

function updateManagementForm() {
    const lineItems = formset_container.querySelectorAll('.selected-line-item');
    let formCount = 0;
    
    lineItems.forEach(line => {
        // Only count forms that are NOT marked for deletion (not hidden and doesn't contain a checked DELETE box)
        const deleteCheckbox = line.querySelector('input[type="checkbox"][id$="-DELETE"]');
        if (line.style.display !== 'none' && (!deleteCheckbox || !deleteCheckbox.checked)) {
            formCount++;
        }
    });
    
    // This is the true number of forms that will be submitted
    delivery_zone_formset_total_input.value = formCount; 

}

// Run on page load to set initial states
document.querySelectorAll('.day-toggle').forEach(toggle => toggleTimeInputs(toggle));
</script>
{% endblock %}