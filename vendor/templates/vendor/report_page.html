{% extends 'vendor_base.html' %}
{% load static %}
{% load humanize %}

{% block vendor_content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="space-y-8">
    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <h1 class="text-3xl font-heading font-black uppercase italic tracking-tighter">
                Sales <span class="text-primary">Analytics</span>
            </h1>
            <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-1">
                Report: {{ start_date|date:"M d" }} - {{ end_date|date:"M d" }}
            </p>
        </div>
        
        <form method="GET" class="flex flex-wrap items-center gap-2 bg-white p-2 rounded-2xl shadow-soft border border-cream">
            <input type="date" name="start" value="{{ request.GET.start }}" class="bg-transparent text-xs font-bold uppercase p-2 focus:outline-none">
            <span class="text-gray-300 font-black">-</span>
            <input type="date" name="end" value="{{ request.GET.end }}" class="bg-transparent text-xs font-bold uppercase p-2 focus:outline-none">
            <button type="submit" class="btn btn-primary btn-sm rounded-xl font-black uppercase italic text-xs">Update Report</button>
            <a href="{% url 'sales_report' %}" class="btn btn-ghost btn-sm btn-circle text-gray-400" title="Reset">↻</a>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-charcoal p-8 rounded-[2.5rem] text-white shadow-heavy relative overflow-hidden group">
            <div class="relative z-10">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-2">Total Revenue</p>
                <h2 class="text-4xl font-black text-primary italic">₦{{ total_revenue|floatformat:0|intcomma }}</h2>
                <p class="text-xs font-medium text-gray-400 mt-2">From {{ total_orders }} completed orders</p>
            </div>
            <div class="absolute -right-6 -bottom-6 opacity-10 group-hover:scale-110 transition-transform duration-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.29 0 2.13-.81 2.13-1.88 0-1.09-.89-1.72-2.83-2.15-2.06-.46-3.41-1.64-3.41-3.37 0-1.72 1.22-3.19 3.27-3.51V3.98h2.67v1.98c1.61.35 2.9.3 3.19 3.27H15.03c-.11-1.06-.96-1.7-2.06-1.7-1.15 0-1.85.73-1.85 1.7 0 1.05.95 1.55 2.76 1.96 2.18.5 3.51 1.63 3.51 3.46 0 2.05-1.55 3.32-3.29 3.63z"/></svg>
            </div>
        </div>

        <div class="bg-white p-8 rounded-[2.5rem] shadow-soft border border-cream relative overflow-hidden">
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-2">Order Analytics</p>
            <h2 class="text-4xl font-black text-charcoal italic">{{ total_orders }}</h2>
            <div class="flex items-center gap-2 mt-2">
                <span class="badge badge-primary badge-outline font-bold text-[10px]">AVG ₦{{ avg_order_value|floatformat:0|intcomma }}</span>
            </div>
        </div>

        <div class="bg-white p-8 rounded-[2.5rem] shadow-soft border border-cream">
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-2">Lead Conversion</p>
            <h2 class="text-4xl font-black text-charcoal italic">{{ conversion_rate|floatformat:0 }}<span class="text-2xl">%</span></h2>
            <p class="text-xs font-medium text-gray-500 mt-2">{{ total_inquiries }} Total Leads</p>
            <progress class="progress progress-success w-full mt-3 h-1.5" value="{{ conversion_rate }}" max="100"></progress>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-[2.5rem] shadow-soft border border-cream">
            <h3 class="font-heading font-black uppercase italic text-lg mb-6">Revenue <span class="text-primary">Trend</span></h3>
            <div class="h-64 w-full">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-soft border border-cream flex flex-col">
            <h3 class="font-heading font-black uppercase italic text-lg mb-6">Delivery <span class="text-primary">Hotspots</span></h3>
            <div class="space-y-4 overflow-y-auto max-h-64 pr-2 custom-scrollbar">
                {% for zone in zone_performance %}
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-charcoal">{{ zone.delivery_zone__name|default:"Pickup/Other" }}</p>
                        <p class="text-[10px] text-gray-400">{{ zone.count }} orders</p>
                    </div>
                    <span class="font-black text-xs text-primary">₦{{ zone.total|floatformat:0|intcomma }}</span>
                </div>
                <div class="w-full bg-base-200 rounded-full h-1.5 mb-2">
                    <div class="bg-charcoal h-1.5 rounded-full" style="width: {% widthratio zone.total total_revenue 100 %}%"></div>
                </div>
                {% empty %}
                <p class="text-gray-400 text-xs text-center py-4">No zone data available.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        
        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden">
            <div class="p-8 border-b border-cream">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter text-charcoal">Top <span class="text-primary">Selling Items</span></h3>
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead class="bg-base-200/30">
                        <tr class="text-[10px] font-black uppercase tracking-widest text-gray-500 border-none">
                            <th>Item Name</th>
                            <th>Qty Sold</th>
                            <th class="text-right">Revenue</th>
                        </tr>
                    </thead>
                    <tbody class="text-xs font-bold">
                        {% for product in top_products %}
                        <tr class="border-b border-cream/50 hover:bg-base-100">
                            <td class="text-charcoal">{{ product.product__name }}</td>
                            <td>{{ product.sold_qty }}</td>
                            <td class="text-right text-primary">₦{{ product.total_generated|floatformat:0|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center py-6 text-gray-400">No product data</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-soft border border-cream overflow-hidden">
            <div class="p-8 border-b border-cream">
                <h3 class="font-heading font-black uppercase italic text-lg tracking-tighter text-charcoal">Loyal <span class="text-primary">Customers</span></h3>
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead class="bg-base-200/30">
                        <tr class="text-[10px] font-black uppercase tracking-widest text-gray-500 border-none">
                            <th>Customer</th>
                            <th>Orders</th>
                            <th class="text-right">Spend</th>
                        </tr>
                    </thead>
                    <tbody class="text-xs font-medium">
                        {% for customer in loyal_customers %}
                        <tr class="border-b border-cream/50 hover:bg-base-100">
                            <td>
                                <p class="font-black text-charcoal">{{ customer.name }}</p>
                                <p class="text-[9px] text-gray-400 uppercase tracking-widest">{{ customer.email|truncatechars:20 }}</p>
                            </td>
                            <td class="font-bold">{{ customer.order_count }}</td>
                            <td class="text-right font-black text-charcoal">₦{{ customer.total_spend|floatformat:0|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center py-6 text-gray-400">No customer data</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_data|json_script:"chart-revenue-data" }}

<script src="{% static "vendor/report_page.js" %}"></script>
{% endblock %}